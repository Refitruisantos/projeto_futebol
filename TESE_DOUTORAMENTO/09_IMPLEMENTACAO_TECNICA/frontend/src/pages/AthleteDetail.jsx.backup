import { useState, useEffect } from 'react'
import { useParams, Link } from 'react-router-dom'
import { athletesApi } from '../api/client'
import { ArrowLeft, TrendingUp, Activity, Heart, Zap } from 'lucide-react'
import { LoadTrendChart, WellnessChart } from '../components/LoadChart'

export default function AthleteDetail() {
  const { id } = useParams()
  const [athlete, setAthlete] = useState(null)
  const [metrics, setMetrics] = useState(null)
  const [comprehensiveProfile, setComprehensiveProfile] = useState(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [sessionFilter, setSessionFilter] = useState('all') // 'all', 'training', 'games'
  const [showRPEDetails, setShowRPEDetails] = useState(false)

  useEffect(() => {
    loadData()
  }, [id])

  // Debug logging
  useEffect(() => {
    if (comprehensiveProfile) {
      console.log('Comprehensive Profile Data:', comprehensiveProfile)
      console.log('Wellness Data:', comprehensiveProfile.wellness_data)
      console.log('Physical Evaluations:', comprehensiveProfile.physical_evaluations)
    }
  }, [comprehensiveProfile])

  const loadData = async () => {
    try {
      setLoading(true)
      const [athleteRes, metricsRes, profileRes] = await Promise.all([
        athletesApi.getById(id),
        athletesApi.getMetrics(id, 7),
        fetch(`http://localhost:8000/api/metrics/athletes/${id}/comprehensive-profile`)
          .then(res => res.json())
          .catch(() => null)
      ])
      setAthlete(athleteRes.data)
      setMetrics(metricsRes.data)
      setComprehensiveProfile(profileRes)
    } catch (err) {
      setError(err.message)
    } finally {
      setLoading(false)
    }
  }

  if (loading) {
    return <div className="text-center py-12">Carregando...</div>
  }

  if (error) {
    return <div className="text-red-600 py-12">Erro: {error}</div>
  }

  const filteredSessions = comprehensiveProfile?.recent_sessions?.filter(session => {
    if (sessionFilter === 'training') return session.tipo === 'treino'
    if (sessionFilter === 'games') return session.tipo === 'jogo'
    return true
  }) || []

  return (
    <div className="px-4 sm:px-6 lg:px-8">
      <div className="mb-6">
        <Link
          to="/athletes"
          className="inline-flex items-center text-sm text-gray-500 hover:text-gray-700"
        >
          <ArrowLeft className="w-4 h-4 mr-1" />
          Voltar aos atletas
        </Link>
      </div>

      {/* Athlete Header */}
      <div className="bg-white shadow rounded-lg mb-6">
        <div className="px-6 py-5">
          <div className="flex items-center space-x-5">
            <div className="flex-shrink-0">
              <div className="w-20 h-20 bg-gray-300 rounded-full flex items-center justify-center">
                <span className="text-2xl font-bold text-gray-600">
                  {athlete?.nome_completo?.split(' ').map(n => n[0]).join('').slice(0, 2)}
                </span>
              </div>
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-gray-900">{athlete?.nome_completo}</h1>
              <div className="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:space-x-6">
                <div className="mt-2 flex items-center text-sm text-gray-500">
                  <span className="font-medium">Posição:</span>
                  <span className="ml-1">{athlete?.posicao}</span>
                </div>
                <div className="mt-2 flex items-center text-sm text-gray-500">
                  <span className="font-medium">Número:</span>
                  <span className="ml-1">{athlete?.numero_camisola}</span>
                </div>
                <div className="mt-2 flex items-center text-sm text-gray-500">
                  <span className="font-medium">Idade:</span>
                  <span className="ml-1">{comprehensiveProfile?.athlete_info?.idade || 'N/A'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Wellness Status */}
      {comprehensiveProfile?.wellness_data && comprehensiveProfile.wellness_data.length > 0 ? (
        <div className="bg-white shadow rounded-lg mb-6">
          <div className="px-6 py-5 border-b border-gray-200">
            <div className="flex items-center">
              <Heart className="w-5 h-5 text-green-500 mr-2" />
              <h2 className="text-lg font-medium text-gray-900">Wellness Status</h2>
            </div>
          </div>
          <div className="px-6 py-5">
            <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
              {/* Current Wellness */}
              <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4">
                <div className="flex items-center">
                  <div className="flex-shrink-0">
                    <Heart className="w-8 h-8 text-green-600" />
                  </div>
                  <div className="ml-3">
                    <p className="text-sm font-medium text-gray-500">Current Score</p>
                    <p className="text-2xl font-semibold text-gray-900">
                      {comprehensiveProfile.wellness_data[0]?.wellness_score?.toFixed(1) || 'N/A'}
                    </p>
                    <p className="text-sm text-gray-600 capitalize">
                      {comprehensiveProfile.wellness_data[0]?.wellness_status || 'Unknown'}
                    </p>
                  </div>
                </div>
              </div>

              {/* Wellness Trend */}
              {comprehensiveProfile.wellness_trends && (
                <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <TrendingUp className={`w-8 h-8 ${
                        comprehensiveProfile.wellness_trends.trend_direction === 'improving' ? 'text-green-600' :
                        comprehensiveProfile.wellness_trends.trend_direction === 'declining' ? 'text-red-600' :
                        'text-yellow-600'
                      }`} />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-gray-500">7-Day Trend</p>
                      <p className="text-2xl font-semibold text-gray-900">
                        {comprehensiveProfile.wellness_trends.avg_score_7d || 'N/A'}
                      </p>
                      <p className={`text-sm capitalize ${
                        comprehensiveProfile.wellness_trends.trend_direction === 'improving' ? 'text-green-600' :
                        comprehensiveProfile.wellness_trends.trend_direction === 'declining' ? 'text-red-600' :
                        'text-yellow-600'
                      }`}>
                        {comprehensiveProfile.wellness_trends.trend_direction}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Training Recommendation */}
              {comprehensiveProfile.wellness_data[0]?.training_recommendation && (
                <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <Zap className="w-8 h-8 text-orange-600" />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-gray-500">Recommendation</p>
                      <p className="text-sm text-gray-900 font-medium">
                        {comprehensiveProfile.wellness_data[0].training_recommendation}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Readiness Score */}
              {comprehensiveProfile.wellness_data[0]?.readiness_score && (
                <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4">
                  <div className="flex items-center">
                    <div className="flex-shrink-0">
                      <Activity className="w-8 h-8 text-purple-600" />
                    </div>
                    <div className="ml-3">
                      <p className="text-sm font-medium text-gray-500">Readiness</p>
                      <p className="text-2xl font-semibold text-gray-900">
                        {comprehensiveProfile.wellness_data[0].readiness_score.toFixed(1)}
                      </p>
                      <p className="text-sm text-gray-600">Training Ready</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      ) : (
        <div className="bg-white shadow rounded-lg mb-6">
          <div className="px-6 py-5">
            <p className="text-gray-500">Loading wellness data...</p>
          </div>
        </div>
      )}

      {/* Physical Evaluations */}
      {comprehensiveProfile?.physical_evaluations && comprehensiveProfile.physical_evaluations.length > 0 ? (
        <div className="bg-white shadow rounded-lg mb-6">
          <div className="px-6 py-5 border-b border-gray-200">
            <div className="flex items-center">
              <Zap className="w-5 h-5 text-blue-500 mr-2" />
              <h2 className="text-lg font-medium text-gray-900">Physical Evaluations</h2>
            </div>
          </div>
          <div className="px-6 py-5">
            {/* Latest Evaluation Summary */}
            {comprehensiveProfile.physical_evaluations[0] && (
              <div className="mb-6">
                <h3 className="text-sm font-medium text-gray-900 mb-4">
                  Latest Evaluation ({new Date(comprehensiveProfile.physical_evaluations[0].data_avaliacao).toLocaleDateString('pt-PT')})
                </h3>
                <div className="grid grid-cols-2 gap-6 sm:grid-cols-4">
                  {/* Speed Tests */}
                  <div className="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-2xl font-bold text-red-600">
                        {comprehensiveProfile.physical_evaluations[0].sprint_35m_seconds?.toFixed(2) || 'N/A'}s
                      </div>
                      <div className="text-sm text-gray-600">35m Sprint</div>
                      <div className="text-xs text-gray-500 mt-1">
                        {comprehensiveProfile.physical_evaluations[0].percentile_speed}th percentile
                      </div>
                    </div>
                  </div>

                  <div className="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-2xl font-bold text-orange-600">
                        {comprehensiveProfile.physical_evaluations[0].test_5_0_5_seconds?.toFixed(2) || 'N/A'}s
                      </div>
                      <div className="text-sm text-gray-600">5-0-5 Agility</div>
                      <div className="text-xs text-gray-500 mt-1">Change of direction</div>
                    </div>
                  </div>

                  {/* Power Tests */}
                  <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-2xl font-bold text-blue-600">
                        {comprehensiveProfile.physical_evaluations[0].cmj_height_cm?.toFixed(1) || 'N/A'}cm
                      </div>
                      <div className="text-sm text-gray-600">CMJ Height</div>
                      <div className="text-xs text-gray-500 mt-1">
                        {comprehensiveProfile.physical_evaluations[0].percentile_power}th percentile
                      </div>
                    </div>
                  </div>

                  {/* Endurance */}
                  <div className="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-4">
                    <div className="text-center">
                      <div className="text-2xl font-bold text-green-600">
                        {comprehensiveProfile.physical_evaluations[0].vo2_max_ml_kg_min?.toFixed(1) || 'N/A'}
                      </div>
                      <div className="text-sm text-gray-600">VO₂ Max</div>
                      <div className="text-xs text-gray-500 mt-1">
                        {comprehensiveProfile.physical_evaluations[0].percentile_endurance}th percentile
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        <div className="bg-white shadow rounded-lg mb-6">
          <div className="px-6 py-5">
            <p className="text-gray-500">Loading physical evaluation data...</p>
          </div>
        </div>
      )}

      {/* Training Load Metrics */}
      {metrics && (
        <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">
          <div className="bg-white shadow rounded-lg">
            <div className="px-6 py-5 border-b border-gray-200">
              <div className="flex items-center">
                <TrendingUp className="w-5 h-5 text-blue-500 mr-2" />
                <h2 className="text-lg font-medium text-gray-900">Tendências de Carga</h2>
              </div>
            </div>
            <div className="px-6 py-5">
              {metrics.load_chart_data && metrics.load_chart_data.length > 0 ? (
                <LoadTrendChart data={metrics.load_chart_data} />
              ) : (
                <p className="text-gray-500">Sem dados de carga disponíveis</p>
              )}
            </div>
          </div>

          <div className="bg-white shadow rounded-lg">
            <div className="px-6 py-5 border-b border-gray-200">
              <div className="flex items-center">
                <Activity className="w-5 h-5 text-green-500 mr-2" />
                <h2 className="text-lg font-medium text-gray-900">Wellness</h2>
              </div>
            </div>
            <div className="px-6 py-5">
              {comprehensiveProfile?.wellness_data && comprehensiveProfile.wellness_data.length > 0 ? (
                <WellnessChart data={comprehensiveProfile.wellness_data.slice(0, 14)} />
              ) : (
                <p className="text-gray-500">Sem dados de wellness disponíveis</p>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Sessions */}
      <div className="mt-6 bg-white shadow rounded-lg">
        <div className="px-6 py-5 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-medium text-gray-900">Sessões</h2>
            <div className="flex space-x-2">
              <button
                onClick={() => setSessionFilter('all')}
                className={`px-3 py-1 text-sm rounded ${
                  sessionFilter === 'all' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Todas ({filteredSessions.length})
              </button>
              <button
                onClick={() => setSessionFilter('training')}
                className={`px-3 py-1 text-sm rounded ${
                  sessionFilter === 'training' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Treino ({comprehensiveProfile?.recent_sessions?.filter(s => s.tipo === 'treino').length || 0})
              </button>
              <button
                onClick={() => setSessionFilter('games')}
                className={`px-3 py-1 text-sm rounded ${
                  sessionFilter === 'games' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                Jogos ({comprehensiveProfile?.recent_sessions?.filter(s => s.tipo === 'jogo').length || 0})
              </button>
            </div>
          </div>
        </div>
        
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-300">
            <thead className="bg-gray-50">
              <tr>
                <th className="py-3 pl-6 pr-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Data
                </th>
                <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Tipo
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Distância
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Vel. Máx
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  RPE
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Carga
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Sono
                </th>
                <th className="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
                  Fadiga
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 bg-white">
              {filteredSessions.map((session) => (
                <tr key={session.sessao_id} className="hover:bg-gray-50">
                  <td className="whitespace-nowrap py-3 pl-6 pr-3 text-sm font-medium text-gray-900">
                    {new Date(session.data).toLocaleDateString('pt-PT')}
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-500">
                    <span className={`inline-flex rounded-full px-2 text-xs font-semibold leading-5 ${
                      session.tipo === 'jogo' 
                        ? 'bg-green-100 text-green-800'
                        : 'bg-blue-100 text-blue-800'
                    }`}>
                      {session.tipo}
                    </span>
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    {session.avg_distance ? `${Math.round(session.avg_distance)}m` : '-'}
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    {session.avg_max_speed ? `${session.avg_max_speed.toFixed(1)} km/h` : '-'}
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    {session.avg_pse_load ? session.avg_pse_load.toFixed(0) : '-'}
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    {session.avg_pse_load ? session.avg_pse_load.toFixed(0) : '-'}
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    -
                  </td>
                  <td className="whitespace-nowrap px-3 py-3 text-sm text-gray-900 text-right">
                    -
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  )
}
