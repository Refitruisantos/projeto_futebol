<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend Upload</title>
</head>
<body>
    <h1>Debug Video Upload</h1>
    <div id="status"></div>
    
    <h2>Test 1: Session Creation</h2>
    <button onclick="testSessionCreation()">Test Session Creation</button>
    
    <h2>Test 2: Video Upload</h2>
    <input type="file" id="videoFile" accept="video/*">
    <button onclick="testVideoUpload()">Test Video Upload</button>
    
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }
        
        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
        
        async function testSessionCreation() {
            log('üß™ Testing session creation...');
            updateStatus('Testing session creation...');
            
            const sessionData = {
                data: "2026-02-02",
                tipo: "jogo",
                adversario: "FC Pa√ßos de Ferreira",
                jornada: 2,
                resultado: "0-1",
                duracao_min: 90,
                local: "casa",
                competicao: "Liga"
            };
            
            try {
                const response = await fetch(`${API_BASE}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sessionData)
                });
                
                log(`Session creation status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Session created: ID ${result.id}`);
                    updateStatus(`Session created: ID ${result.id}`);
                    return result.id;
                } else {
                    const error = await response.text();
                    log(`‚ùå Session creation failed: ${error}`);
                    updateStatus(`Session creation failed: ${response.status}`);
                    return null;
                }
            } catch (error) {
                log(`‚ùå Session creation error: ${error.message}`);
                updateStatus(`Session creation error: ${error.message}`);
                return null;
            }
        }
        
        async function testVideoUpload() {
            log('üé¨ Testing video upload...');
            updateStatus('Testing video upload...');
            
            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files[0]) {
                log('‚ùå Please select a video file first');
                return;
            }
            
            // First create a session
            const sessionId = await testSessionCreation();
            if (!sessionId) {
                log('‚ùå Cannot upload video without session');
                return;
            }
            
            const file = fileInput.files[0];
            log(`üìπ Uploading file: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)} MB)`);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('session_id', sessionId);
            formData.append('analysis_type', 'quick');
            formData.append('confidence_threshold', '0.5');
            formData.append('sample_rate', '10');
            
            try {
                updateStatus('Uploading video...');
                const response = await fetch(`${API_BASE}/computer-vision/upload-video`, {
                    method: 'POST',
                    body: formData
                });
                
                log(`Video upload status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Video upload successful!`);
                    log(`   Analysis ID: ${result.analysis_id}`);
                    log(`   Status: ${result.status}`);
                    updateStatus(`Video uploaded successfully! Analysis ID: ${result.analysis_id}`);
                } else {
                    const error = await response.text();
                    log(`‚ùå Video upload failed: ${error}`);
                    updateStatus(`Video upload failed: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Video upload error: ${error.message}`);
                updateStatus(`Video upload error: ${error.message}`);
            }
        }
        
        // Test basic connectivity on page load
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/computer-vision/models/info`);
                if (response.ok) {
                    log('‚úÖ Backend server is reachable');
                    updateStatus('Backend server is reachable');
                } else {
                    log('‚ùå Backend server returned error: ' + response.status);
                    updateStatus('Backend server error: ' + response.status);
                }
            } catch (error) {
                log('‚ùå Cannot connect to backend server: ' + error.message);
                updateStatus('Cannot connect to backend server');
            }
        };
    </script>
</body>
</html>
